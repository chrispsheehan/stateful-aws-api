services:
  dev-app:
    depends_on:
      dynamodb-check:
        condition: service_completed_successfully
    image: node:alpine
    environment:
      - DYNAMODB_TABLE=stateful_aws_api_tasks
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - DYNAMODB_AWS_REGION=local
      - AWS_ACCESS_KEY_ID=DUMMYIDEXAMPLE
      - AWS_SECRET_ACCESS_KEY=DUMMYEXAMPLEKEY
      - API_PORT=9000
    container_name: dev-app
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --spider --tries=1 http://localhost:9000/hello || exit 1"]
      interval: 10s
      timeout: 2s
      retries: 3
    volumes:
      - ./:/app
    working_dir: /app
    command: ["npx", "nodemon", "./src/app.local.ts"]

  dev-test:
    depends_on:
      dev-app:
        condition: service_healthy
    image: node:slim
    environment: 
      - BASE_URL=http://dev-app:9000
    container_name: dev-test
    volumes:
      - ./:/app
    working_dir: /app
    command: ["npx", "nodemon", "--watch", ".", "--ext", ".ts", "--exec", "npm", "test"]

